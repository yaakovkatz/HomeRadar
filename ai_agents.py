"""
ai_agents.py - AI Agents for post classification and data extraction
Agent 1: Classification (RELEVANT/SPAM/BROKER/etc) - with image support
Agent 2: Extraction (fill missing price/city)
"""

import os
import json
from anthropic import Anthropic
from dotenv import load_dotenv
import time


# ×˜×¢×™× ×ª API Key ×-.env
load_dotenv()


class AIAgents:
    def __init__(self):
        """Initialize AI Agents with Anthropic API"""
        api_key = os.getenv('ANTHROPIC_API_KEY')
        if not api_key:
            raise ValueError("âŒ ANTHROPIC_API_KEY ×œ× × ××¦× ×‘×§×•×‘×¥ .env")

        self.client = Anthropic(api_key=api_key)
        self.model = "claude-sonnet-4-20250514"  # Sonnet 4

        self.last_call = 0
        self.min_delay = 0.5  # 500ms ×‘×™×Ÿ ×§×¨×™××•×ª

        print("âœ… AI Agents initialized successfully")

    def _wait_if_needed(self):
        """×××ª×™×Ÿ ×× ×¢×‘×¨×• ×¤×—×•×ª ×-500ms ××”×§×¨×™××” ×”××—×¨×•× ×”"""
        now = time.time()
        elapsed = now - self.last_call
        if elapsed < self.min_delay:
            time.sleep(self.min_delay - elapsed)
        self.last_call = time.time()

    # =========================================================
    # Agent 1: Classification (×¡×™× ×•×Ÿ) - ×¢× ×ª××™×›×” ×‘×ª××•× ×•×ª
    # =========================================================

    def classify_post(self, content, author, images=None):
        """
        Agent 1: ××¡×•×•×’ ×¤×•×¡×˜ ×œ×§×˜×’×•×¨×™×” (×¢× ×ª××™×›×” ×‘×ª××•× ×•×ª!)

        Args:
            content: ×ª×•×›×Ÿ ×”×¤×•×¡×˜
            author: ×©× ×”××¤×¨×¡×
            images: ×¨×©×™××ª URLs ×©×œ ×ª××•× ×•×ª (××•×¤×¦×™×•× ×œ×™)

        Returns:
            {
                'category': 'RELEVANT' | 'BROKER' | 'SPAM' | 'AUCTION' | 'WANTED' | 'QUESTION',
                'is_broker': True/False,
                'confidence': 0.0-1.0,
                'reason': '×”×¡×‘×¨ ×§×¦×¨'
            }
        """

        self._wait_if_needed()

        prompt = f"""××ª×” ××•××—×” ×œ×¡×™×•×•×’ ×¤×•×¡×˜×™× ×‘×§×‘×•×¦×•×ª ×¤×™×™×¡×‘×•×§ ×©×œ ×“×™×¨×•×ª ×™×“ ×©× ×™×™×”.

{"×§×¨× ××ª ×”×ª××•× ×•×ª ×•×”×¤×•×¡×˜" if images else "×§×¨× ××ª ×”×¤×•×¡×˜ ×”×‘×"} ×•×¡×•×•×’ ××•×ª×• ×œ××—×ª ××”×§×˜×’×•×¨×™×•×ª:

**RELEVANT** - ×“×™×¨×” ×œ××›×™×¨×”/×”×©×›×¨×” (×¨×œ×•×•× ×˜×™!)
- ×™×© ×ª×™××•×¨ ×“×™×¨×” (×—×“×¨×™×, ××˜×¨, ×§×•××” ×•×›×•')
- ×™×›×•×œ ×œ×”×™×•×ª ×¢× ××• ×‘×œ×™ ××—×™×¨
- ×™×›×•×œ ×œ×”×™×•×ª ×××ª×•×•×š ××• ××‘×¢×œ×™×
- **×—×©×•×‘: ×¨×§ ×‘×¢×¨×™× ×”×¨×œ×•×•× ×˜×™×•×ª!** (×¨××” NON_URBAN ×œ××˜×”)

**NON_URBAN** - ××•×©×‘/×›×¤×¨/×™×™×©×•×‘/×¢×™×¨ ×œ× ×¨×œ×•×•× ×˜×™×ª
- ×“×™×¨×”/×‘×™×ª ×‘××•×©×‘, ×›×¤×¨, ×™×™×©×•×‘ ×§×”×™×œ×ª×™, ×”×ª× ×—×œ×•×ª ×•×›×•'
- **××• ×¢×™×¨ ×©×œ× ×‘×¨×©×™××” ×”×¨×œ×•×•× ×˜×™×ª!**
- **×¨×§ ×¢×¨×™× ×¨×œ×•×•× ×˜×™×•×ª:** ×™×¨×•×©×œ×™×, ××¢×œ×” ××“×•××™×, ×‘×™×ª ×©××©, ×‘× ×™ ×‘×¨×§, ×¨××ª ×’×Ÿ, ×’×‘×¢×ª×™×™×, ××©×“×•×“
- **×¢×¨×™× ×œ× ×¨×œ×•×•× ×˜×™×•×ª - ×¡× ×Ÿ ××™×“:**
  - ×ª×œ ××‘×™×‘ â†’ NON_URBAN (×œ× ×‘×¨×©×™××”)
  - ×—×™×¤×” â†’ NON_URBAN (×œ× ×‘×¨×©×™××”)
  - ×¨××ª ×”×©×¨×•×Ÿ â†’ NON_URBAN (×œ× ×‘×¨×©×™××”)
  - ×¤×ª×— ×ª×§×•×•×” â†’ NON_URBAN (×œ× ×‘×¨×©×™××”)
  - × ×ª× ×™×” â†’ NON_URBAN (×œ× ×‘×¨×©×™××”)
- **×™×™×©×•×‘×™× ×§×˜× ×™× - ×¡× ×Ÿ ××™×“:**
  - "× ×•×¤×™×" (×™×™×©×•×‘ ×‘×‘×™×ª ×©××©) â†’ NON_URBAN âš ï¸ ×—×©×•×‘!
  - "× ×•×£ ××™×™×œ×•×Ÿ" â†’ NON_URBAN
  - "××¦×¤×” × ×˜×•×¤×”" â†’ NON_URBAN
  - "×›×¤×¨ ××“×•××™×" â†’ NON_URBAN
  - "××œ×•×Ÿ ×©×‘×•×ª" â†’ NON_URBAN
  - "××¤×¨×ª" â†’ NON_URBAN
  - "××•×©×‘ ×¦×•×¨ ××©×”" â†’ NON_URBAN
  - "×™×™×©×•×‘ ×§×”×™×œ×ª×™ X" â†’ NON_URBAN
  - "×”×ª× ×—×œ×•×ª Y" â†’ NON_URBAN
- **×©×›×•× ×•×ª ×™×“×•×¢×•×ª - ×“×•×’×××•×ª:**
  - **×™×¨×•×©×œ×™×:** × ×—×œ××•×ª, ×××” ×©×¢×¨×™×, ×’××•×œ×”, ×§×˜××•×Ÿ, ×¨××•×ª, ×ª×œ×¤×™×•×ª, ××¨× ×•× ×”, ×¤×¡×’×ª ×–××‘, ×’×‘×¢×ª ×©××•×œ, ×§×¨×™×™×ª ×™×•×‘×œ, ×¨×•×××”, ×‘×™×ª ×•×’×Ÿ, ×’×™×œ×”, ××•×¨×“×•×ª ×’×™×œ×”, German Colony
  - **×‘×™×ª ×©××©:** × ×•×•×” ×©××™×¨, ×¨××ª ×‘×™×ª ×©××©, ×”×¨ ×˜×•×‘
  - **×‘× ×™ ×‘×¨×§:** ×¤×¨×“×¡ ×›×¥, ×¢×–×¨×, ×’×‘×¢×ª ×¨×•×§×—

**ğŸ”¥ ×›×œ×œ ×–×”×‘ (×—×©×•×‘ ×××•×“!):**
1. **×× ×©× ×”×§×‘×•×¦×” ××›×™×œ "×™×¨×•×©×œ×™×" / "×‘×™×ª ×©××©" / "×‘× ×™ ×‘×¨×§" / "×¨××ª ×’×Ÿ" / "×’×‘×¢×ª×™×™×" / "××©×“×•×“" / "××¢×œ×” ××“×•××™×":**
   - â†’ ×›×œ ×©×›×•× ×”/××™×§×•× ×‘××•×ª×” ×¢×™×¨ = **RELEVANT** (×’× ×× ×œ× ××›×™×¨ ××ª ×”×©×!)
   - â†’ ×¡× ×Ÿ ×¨×§ ×× ×™×© ××™×œ×•×ª ××¤×ª×— ××¤×•×¨×©×•×ª: "××•×©×‘", "×™×™×©×•×‘", "×›×¤×¨", "×”×ª× ×—×œ×•×ª"
   - ×“×•×’×××•×ª:
     * ×§×‘×•×¦×”: "×“×™×¨×•×ª ×‘×™×¨×•×©×œ×™×" + ××™×§×•×: "××•×¨×“×•×ª ×’×™×œ×”" â†’ **RELEVANT** âœ…
     * ×§×‘×•×¦×”: "×“×™×¨×•×ª ×‘×™×¨×•×©×œ×™×" + ××™×§×•×: "××•×©×‘ ×¦×•×¨ ×”×“×¡×”" â†’ **NON_URBAN** âŒ (×™×© "××•×©×‘")

2. **×× ×©× ×”×§×‘×•×¦×” ×œ× ××›×™×œ ×¢×™×¨:**
   - â†’ ×‘×“×•×§ ×× ×”××™×§×•× ×‘×¤×•×¡×˜ ×”×•× ×¢×™×¨ ×¨×œ×•×•× ×˜×™×ª
   - ×× ×›×Ÿ â†’ **RELEVANT**
   - ×× ×œ× â†’ **NON_URBAN**

- **×–×™×”×•×™ ×—×›×:** ×× ×”×˜×§×¡×˜ ××›×™×œ "××•×©×‘", "×™×™×©×•×‘", "×”×ª× ×—×œ×•×ª", "×›×¤×¨" **×‘××¤×•×¨×©** â†’ NON_URBAN
- **×—×©×•×‘!** ×‘-reason ×ª××™×“ ×¦×™×™×Ÿ: "[×©× ×”××™×§×•×] - [×¡×™×‘×”]" (×œ××©×œ: "×¨××ª ×”×©×¨×•×Ÿ - ×¢×™×¨ ×œ× ×‘×¨×©×™××”")

**AUCTION** - ××›×¨×–/×›×•× ×¡ × ×›×¡×™×/××›×™×¨×” ×¤×•××‘×™×ª
- ×ª××•× ×” ××• ×˜×§×¡×˜ ×¢× "×›×•× ×¡ × ×›×¡×™×", "××›×¨×–", "×”×–×× ×” ×œ×”×¦×™×¢ ×”×¦×¢×•×ª"
- ××›×™×¨×” ×¤×•××‘×™×ª, ×¨×›×™×©×ª ×–×›×•×™×•×ª

**SUSPECTED_BROKER** - ×“×™×¨×” ×¨×œ×•×•× ×˜×™×ª ×¢× ×—×©×“ ×œ××ª×•×•×š ğŸŸ¡
- **×™×© ×ª×™××•×¨ ×“×™×¨×” ×¡×¤×¦×™×¤×™×ª** (×›××• RELEVANT)
- ××‘×œ ×™×© ×¡×™×× ×™× ×—×©×•×“×™× ×©×–×” ××•×œ×™ ××ª×•×•×š:
  * ×©× ×—×‘×¨×”: "××•×¨ × ×›×¡×™×", "××¨×™×” × ×›×¡×™×", "[×©×] real estate"
  * ××‘× ×” ××§×¦×•×¢×™ ××“×™ (××‘×œ ×œ×œ× ××¡×¤×¨ ×¨×™×©×™×•×Ÿ!)
  * ×˜×•×Ÿ ×¢×¡×§×™ ×—×–×§ (××‘×œ ×œ× ××¡×¤×™×§ ×‘×¨×•×¨)
- **×œ× ××¡×¤×™×§ ×¨××™×•×ª ×—×–×§×•×ª** ×œ×¡×•×•×’ ×›-BROKER ×•×•×“××™
- **×“×•×’×××•×ª:**
  * "×“×™×¨×” 4 ×—×“×¨×™×... ××•×¨ × ×›×¡×™× 054-1234567" â†’ SUSPECTED_BROKER
  * "×œ×”×©×›×¨×” ×‘×‘× ×™ ×‘×¨×§... × ×›×¡×™× ×¤×œ×•×¡ ×œ×™××•×¨" â†’ SUSPECTED_BROKER
- **×”××˜×¨×”:** ×œ×ª×ª ×œ××©×ª××© ×œ×”×—×œ×™×˜ ×× ×œ×”×•×¡×™×£ ×œ×¨×©×™××” ×©×—×•×¨×”

**BROKER** - ××ª×•×•×š ××—×¤×© ×œ×§×•×—×•×ª (×œ× ×“×™×¨×” ×¡×¤×¦×™×¤×™×ª!)
- ×›×ª×•×‘ "××—×¤×© ×œ×§×•×—×•×ª", "×ª×™×§ × ×›×¡×™×", "×©×™×¨×•×ª ×ª×™×•×•×š"
- ××™×Ÿ ×ª×™××•×¨ ×“×™×¨×” ×¡×¤×¦×™×¤×™×ª

**×–×™×”×•×™ ××ª×•×•×›×™× ×¡××•×™×™× (×—×©×•×‘!):**
××ª×•×•×›×™× ×œ×¤×¢××™× **××¡×ª×™×¨×™×** ×©×”× ××ª×•×•×›×™×. ×©×™× ×œ×‘ ×œ:
- âœ… **××¡×¤×¨ ×¨×™×©×™×•×Ÿ ××ª×•×•×š** (×”×›×™ ×—×©×•×‘!):
  * "××¡×¤×¨ ×¨×™×©×™×•×Ÿ: 1234567", "×.×¨. 1234567", "×‘×¨×™×©×™×•×Ÿ 1234567"
  * **×× ×™×© ××¡×¤×¨ ×¨×™×©×™×•×Ÿ â†’ ×–×” 100% ××ª×•×•×š!**
- âœ… ×—×ª×™××” ×¢×¡×§×™×ª: "× ×“×œ×´×Ÿ JF", "Real Estate X", "× ×›×¡×™× ×¤×œ×•×¡", "××§×¡×™× × ×“×œ×´×Ÿ", "×“×•×¨×•×Ÿ × ×›×¡×™×"
- âœ… ××¡×¤×¨ × ×›×¡×™× ×‘××•×ª×• ×¤×•×¡×˜ (×™×•×ª×¨ ××“×™×¨×” ××—×ª)
- âœ… ×˜×•×Ÿ ×¢×¡×§×™ + ×—×ª×™××” ××§×¦×•×¢×™×ª: "×œ×¤×¨×˜×™× ×•×ª×™××•×: ×©×™×¨×” 050-1234567"
- âœ… ×¨×™×‘×•×™ ××™×™×§×•× ×™× ×¤×¨×¡×•××™×™× (âœ¨ğŸ“ğŸ’ğŸ ) + ×¢×™×¦×•×‘ ××¡×—×¨×™
- âœ… ×›×•×ª×¨×ª ××¡×—×¨×™×ª: "×¢×¡×§×ª ×¤×¨×™××™×•×!", "×”×–×“×× ×•×ª × ×“×™×¨×”!", "×‘×œ×¢×“×™!"

**××‘×œ ×©×™× ×œ×‘:**
- âŒ ××“× ×¤×¨×˜×™ ×©×›×•×ª×‘ ×˜×•×‘ â‰  ××ª×•×•×š
- âŒ ×©×™××•×© ×‘×××•×’'×™× ×‘×œ×‘×“ â‰  ××ª×•×•×š
- âŒ ×¤×•×¡×˜ ××¡×•×“×¨ ×¢× ×¤×¨×˜×™× â‰  ××ª×•×•×š

**×× ×–×” ××ª×•×•×š ×¡××•×™:**
â†’ category: "RELEVANT", is_broker: true, reason: "××ª×•×•×š (×—×ª×™××” ×¢×¡×§×™×ª: × ×“×œ×´×Ÿ X)"

**SPAM** - ×¤×¨×¡×•× ×œ× ×§×©×•×¨
- ×©×™×¤×•×¦×™×, × ×§×™×•×Ÿ, ×”×•×‘×œ×•×ª (×‘×ª××•× ×” ××• ×‘×˜×§×¡×˜)
- ×œ× ×§×©×•×¨ ×œ×“×™×¨×•×ª

**WANTED** - ××—×¤×© ×“×™×¨×” (×œ× ××•×›×¨!)
- "××—×¤×© ×“×™×¨×”", "×“×¨×•×©", "×¦×¨×™×š"

**ROOMMATE** - ×—×™×¤×•×© ×©×•×ª×£/×¡××‘×œ×˜ âŒ
- **×¡××‘×œ×˜/×ª×ª-×”×©×›×¨×”:** "××¡××‘×œ×˜", "×ª×ª ×”×©×›×¨×”", "×œ×”×©×›×™×¨ ××ª ×”×“×™×¨×” ×©×œ×™"
- **×—×™×¤×•×© ×©×•×ª×¤×™×:** "××—×¤×© ×©×•×ª×£", "××—×¤×©×ª ×©×•×ª×¤×”", "×©×•×ª×£ ×œ×“×™×¨×”"
- **×”×¦×¢×ª ×—×“×¨:** "×—×“×¨ ×¤× ×•×™", "×—×“×¨ ×œ×”×©×›×¨×” ×‘×“×™×¨×” ××©×•×ª×¤×ª"
- **×“×•×’×××•×ª:**
  * "××¡××‘×œ×˜ ×“×™×¨×” ×œ×¡×•×¤×´×©" â†’ ROOMMATE
  * "××—×¤×©×ª ×©×•×ª×¤×” ×œ×“×™×¨×” ×‘× ×—×œ××•×ª" â†’ ROOMMATE
  * "×—×“×¨ ×¤× ×•×™ ×‘×“×™×¨×” 4 ×—×“×¨×™×" â†’ ROOMMATE

**QUESTION** - ×©××œ×”
- "××™×©×”×• ×™×•×“×¢?", "××™×š...?", "×¢×–×¨×”"

---

**×¤×•×¡×˜:**
××¤×¨×¡×: {author}
×ª×•×›×Ÿ: {content[:500]}
{"×ª××•× ×•×ª: ××¦×•×¨×¤×•×ª (×§×¨× ××•×ª×Ÿ!)" if images else ""}

---

**×—×©×•×‘ - ×ª××•× ×•×ª:**
- ×× ×™×© ×ª××•× ×” ×¢× "×›×•× ×¡ × ×›×¡×™×", "××›×¨×–", "×”×–×× ×” ×œ×”×¦×™×¢ ×”×¦×¢×•×ª" â†’ AUCTION
- ×× ×™×© ×ª××•× ×” ×©×œ ×¤×¨×¡×•× (×”×•×‘×œ×•×ª, ×©×™×¤×•×¦×™×, × ×§×™×•×Ÿ) â†’ SPAM
- ×§×¨× ××ª ×”×ª××•× ×•×ª ×‘×§×¤×™×“×”!

**×—×©×•×‘ - ×ª×’×•×‘×•×ª:**
- ×”×˜×§×¡×˜ ×¢×œ×•×œ ×œ×”×›×™×œ ×ª×’×•×‘×•×ª ×©×œ ×× ×©×™× ××—×¨×™× (×›××• "××©×”: ×ª×’×•×‘×ª×™ ×××•×“!")
- **×”×ª×¢×œ× ×œ×’××¨×™ ××ª×’×•×‘×•×ª!**
- ×”×ª××§×“ **×¨×§ ×‘×ª×•×›×Ÿ ×”××§×•×¨×™** ×©×œ ×”×¤×•×¡×˜
- ×ª×’×•×‘×•×ª ××ª×—×™×œ×•×ª ×œ×¨×•×‘ ×‘×©× ××“× + "×ª×’×•×‘×ª×™", "××” ×–×”", "×™×§×¨ ××“×™" ×•×›×•'
- ×× ×™×© ×ª×™××•×¨ ×“×™×¨×” ×‘×¤×•×¡×˜ ×”××§×•×¨×™ â†’ RELEVANT (×’× ×× ×™×© ×ª×’×•×‘×” ×©××œ×”!)

---

**×”×—×–×¨ ×ª×©×•×‘×” ×‘-JSON ×‘×“×™×•×§ ×‘×¤×•×¨××˜ ×”×–×” (×œ×œ× ×˜×§×¡×˜ × ×•×¡×£):**
{{
    "category": "RELEVANT",
    "is_broker": false,
    "confidence": 0.95,
    "reason": "×“×™×¨×” ×œ××›×™×¨×” ×¢× ×ª×™××•×¨ ××¤×•×¨×˜"
}}

**×›×œ×œ×™×:**
1. **×¡××‘×œ×˜/×©×•×ª×¤×™×** - "××¡××‘×œ×˜", "×ª×ª ×”×©×›×¨×”", "××—×¤×© ×©×•×ª×£" â†’ category: "ROOMMATE" âš ï¸ ×—×©×•×‘!
2. **××ª×•×•×š ×•×•×“××™** (××¡×¤×¨ ×¨×™×©×™×•×Ÿ / ×—×ª×™××” ××¤×•×¨×©×ª) â†’ category: "RELEVANT", is_broker: true
3. **×—×©×“ ×œ××ª×•×•×š** (×©× ×—×‘×¨×ª × ×›×¡×™× / ××‘× ×” ×¢×¡×§×™ ××‘×œ ×œ× ×‘×¨×•×¨) â†’ category: "SUSPECTED_BROKER", is_broker: false
4. ×× ××ª×•×•×š ××—×¤×© ×œ×§×•×—×•×ª (×œ× ×“×™×¨×” ×¡×¤×¦×™×¤×™×ª) â†’ category: "BROKER", is_broker: true
5. ×× ××›×¨×–/×›×•× ×¡ × ×›×¡×™× â†’ category: "AUCTION", is_broker: false
6. confidence: 0.5-1.0 (×¢×“ ×›××” ××ª×” ×‘×˜×•×—)
7. ×× confidence < 0.5 â†’ category: "RELEVANT" (×‘××§×¨×” ×¡×¤×§)
8. **×©× ×—×‘×¨×” ×›××• "××•×¨ × ×›×¡×™×", "××¨×™×” × ×›×¡×™×"** â†’ SUSPECTED_BROKER (×œ× RELEVANT!)

**×—×©×•×‘ - ×¤×•×¨××˜ ×”-reason:**
- **×ª××™×“ ×¦×™×™×Ÿ ××ª ×”××™×§×•× ×©×–×™×”×™×ª!**
- ×¤×•×¨××˜: "[××™×§×•× ××–×•×”×”] - [×¡×™×‘×ª ×”×¡×™× ×•×Ÿ]"
- ×“×•×’×××•×ª:
  * NON_URBAN: "×¨××ª ×”×©×¨×•×Ÿ - ×¢×™×¨ ×œ× ×‘×¨×©×™××” ×”×¨×œ×•×•× ×˜×™×ª"
  * NON_URBAN: "German Colony, Jerusalem - ×©×›×•× ×” ×œ× ××•×›×¨×ª (××™×Ÿ ×‘×¨×©×™××ª ×”×©×›×•× ×•×ª)"
  * SUSPECTED_BROKER: "×‘× ×™ ×‘×¨×§ - ×—×©×“ ×œ××ª×•×•×š (××•×¨ × ×›×¡×™×)"
  * RELEVANT: "×™×¨×•×©×œ×™×, × ×—×œ××•×ª - ×“×™×¨×” ×¨×œ×•×•× ×˜×™×ª"

**×“×•×’×××•×ª:**

âœ… ××ª×•×•×š ×¡××•×™ (××¡×¤×¨ ×¨×™×©×™×•×Ÿ):
"×“×™×¨×ª 5 ×—×“×¨×™× ×‘××™×§×•× ××¢×•×œ×”!
×œ×¤×¨×˜×™×: ×“×•×¨×•×Ÿ × ×›×¡×™× 054-9388399
××¡×¤×¨ ×¨×™×©×™×•×Ÿ: 3205091"
â†’ category: "RELEVANT", is_broker: true, reason: "××ª×•×•×š (××¡×¤×¨ ×¨×™×©×™×•×Ÿ: 3205091)"

âœ… ××ª×•×•×š ×¡××•×™ (×.×¨.):
"×“×™×¨×” ×¢× ×§×™×ª! ×”××•×Ÿ ×¤×•×˜× ×¦×™××œ!
×œ×¤×¨×˜×™×: ××¡×£ 050-2262874
×.×¨. 3243938"
â†’ category: "RELEVANT", is_broker: true, reason: "××ª×•×•×š (×.×¨. 3243938)"

âœ… ××ª×•×•×š ×¡××•×™ (×—×ª×™××”):
"×“×™×¨×ª 4 ×—×“×¨×™× ××“×”×™××” âœ¨ ×‘××™×§×•× ×¤×¨×™××™×•× ğŸ“
×œ×¤×¨×˜×™× ×•×ª×™××•×: ×¡×ª×™×• - × ×“×œ×´×Ÿ JF ğŸ“ 054-7895735"
â†’ category: "RELEVANT", is_broker: true, reason: "××ª×•×•×š (×—×ª×™××”: × ×“×œ×´×Ÿ JF)"

âœ… ××ª×•×•×š ×¡××•×™ (××¡×¤×¨ × ×›×¡×™×):
"ğŸ’ 3 ×“×™×¨×•×ª ×—×“×©×•×ª ×‘×ª×œ ××‘×™×‘! ğŸ 
Real Estate Plus | ×©×™×¨×” 050-1234567"
â†’ category: "RELEVANT", is_broker: true, reason: "××ª×•×•×š (××¡×¤×¨ × ×›×¡×™× + Real Estate Plus)"

ğŸŸ¡ ×—×©×•×“ ×œ××ª×•×•×š (×©× ×—×‘×¨×”):
"×œ××›×™×¨×” ×‘×¨×—×•×‘ ×”×©× ×™×™× ×‘×‘× ×™ ×‘×¨×§
×“×™×¨×ª 4 ×—×“×¨×™× - ××¨×•×•×—×ª ×•××•××¨×ª - 85 ××´×¨
×œ×¤×¨×˜×™× × ×•×¡×¤×™× - ×œ×™××•×¨ - 0545477042
××•×¨ × ×›×¡×™×"
â†’ category: "SUSPECTED_BROKER", is_broker: false, reason: "×‘× ×™ ×‘×¨×§ - ×—×©×“ ×œ××ª×•×•×š (××•×¨ × ×›×¡×™×)"

ğŸŸ¡ ×—×©×•×“ ×œ××ª×•×•×š (×¤×•×¨××˜ ×¢×¡×§×™):
"×“×™×¨×” 5 ×—×“×¨×™× ×‘×™×¨×•×©×œ×™× ğŸ  ××™×§×•× ××¢×•×œ×” âœ¨
××¨×™×” × ×›×¡×™× - 054-1234567"
â†’ category: "SUSPECTED_BROKER", is_broker: false, reason: "×™×¨×•×©×œ×™× - ×—×©×“ ×œ××ª×•×•×š (××¨×™×” × ×›×¡×™×)"

ğŸŸ¡ ×—×©×•×“ ×œ××ª×•×•×š (real estate):
"3 rooms apartment in Beit Shemesh
For details: Dan Real Estate 052-5555555"
â†’ category: "SUSPECTED_BROKER", is_broker: false, reason: "×‘×™×ª ×©××© - ×—×©×“ ×œ××ª×•×•×š (Dan Real Estate)"

ğŸš« ×¢×™×¨ ×œ× ×¨×œ×•×•× ×˜×™×ª:
"×“×™×¨×” 4 ×—×“×¨×™× ×‘×¨××ª ×”×©×¨×•×Ÿ
3,500â‚ª ×œ×—×•×“×©, ××¢×œ×™×ª ×•×—× ×™×”"
â†’ category: "NON_URBAN", is_broker: false, reason: "×¨××ª ×”×©×¨×•×Ÿ - ×¢×™×¨ ×œ× ×‘×¨×©×™××” ×”×¨×œ×•×•× ×˜×™×ª"

ğŸš« ××•×©×‘ (×’× ×× ×‘×§×‘×•×¦×ª ×™×¨×•×©×œ×™×):
"×§×‘×•×¦×”: ×“×™×¨×•×ª ×‘×™×¨×•×©×œ×™×
×“×™×¨×” 5 ×—×“×¨×™× ×‘××•×©×‘ ×¦×•×¨ ×”×“×¡×”
××™×§×•× ××¢×•×œ×”, ×’×™× ×” ×¤×¨×˜×™×ª"
â†’ category: "NON_URBAN", is_broker: false, reason: "××•×©×‘ ×¦×•×¨ ×”×“×¡×” - ×™×™×©×•×‘ ×œ× ×¨×œ×•×•× ×˜×™ (××•×©×‘)"

âœ… ×©×›×•× ×” ×‘×™×¨×•×©×œ×™× (×’× ×× ×œ× ××•×›×¨×ª!):
"×§×‘×•×¦×”: ×“×™×¨×•×ª ×œ×”×©×›×¨×” ×‘×™×¨×•×©×œ×™×
×“×™×¨×ª 4 ×—×“×¨×™× ×‘××•×¨×“×•×ª ×’×™×œ×”
××¨×•×•×—×ª ×•××•××¨×ª, 5 ×“×§×•×ª ×××œ×—×”"
â†’ category: "RELEVANT", is_broker: false, reason: "×™×¨×•×©×œ×™×, ××•×¨×“×•×ª ×’×™×œ×” - ×“×™×¨×” ×¨×œ×•×•× ×˜×™×ª"

ğŸš« ×¡××‘×œ×˜ (×œ× ×¨×œ×•×•× ×˜×™):
"××¡××‘×œ×˜ ××ª ×”×“×™×¨×” ×‘× ×—×œ××•×ª ×œ×¡×•×¤×´×© ×”×‘×: 4-7.2
×”×“×™×¨×” ××”×××ª, ×™×© ×œ×” ×’×™× ×” ×’×“×•×œ×”, ××˜×‘×— ×××•×‘×–×¨..."
â†’ category: "ROOMMATE", is_broker: false, reason: "× ×—×œ××•×ª, ×™×¨×•×©×œ×™× - ×¡××‘×œ×˜ (×œ× ×¨×œ×•×•× ×˜×™)"

ğŸš« ×—×™×¤×•×© ×©×•×ª×£ (×œ× ×¨×œ×•×•× ×˜×™):
"××—×¤×©×ª ×©×•×ª×¤×” ×œ×“×™×¨×” 3 ×—×“×¨×™× ×‘×‘× ×™ ×‘×¨×§
×§×•××” 2, ××¢×œ×™×ª, 1,500â‚ª ×œ×—×•×“×©"
â†’ category: "ROOMMATE", is_broker: false, reason: "×‘× ×™ ×‘×¨×§ - ×—×™×¤×•×© ×©×•×ª×¤×” (×œ× ×¨×œ×•×•× ×˜×™)"

âœ… ×“×™×¨×” ×¨×œ×•×•× ×˜×™×ª:
"×“×™×¨×” ×™×¤×” ×œ×”×©×›×¨×”! 3 ×—×“×¨×™×, ××¢×œ×™×ª, ×—× ×™×” ğŸ¡
× ×—×œ××•×ª, ×™×¨×•×©×œ×™×
×œ××¢×•× ×™×™× ×™×: ×™×•×¡×™ 052-9876543"
â†’ category: "RELEVANT", is_broker: false, reason: "×™×¨×•×©×œ×™×, × ×—×œ××•×ª - ×“×™×¨×” ×¨×œ×•×•× ×˜×™×ª"
"""

        try:
            # ×‘× ×™×™×ª message ×¢× ×ª××•× ×•×ª
            message_content = []

            # ×× ×™×© ×ª××•× ×•×ª - ×”×•×¡×£ ××•×ª×Ÿ ×§×•×“×
            if images:
                for image_url in images:
                    message_content.append({
                        "type": "image",
                        "source": {
                            "type": "url",
                            "url": image_url
                        }
                    })

            # ×”×•×¡×£ ××ª ×”×˜×§×¡×˜
            message_content.append({
                "type": "text",
                "text": prompt
            })

            # ×©×œ×— ×œ-Claude
            response = self.client.messages.create(
                model=self.model,
                max_tokens=200,
                temperature=0,
                messages=[{"role": "user", "content": message_content}]
            )

            # ×—×™×œ×•×¥ ×”×ª×©×•×‘×”
            result_text = response.content[0].text.strip()

            # × ×™×§×•×™ markdown backticks ×× ×™×©
            result_text = result_text.replace('```json', '').replace('```', '').strip()

            # ×”××¨×” ×œ-JSON ×¢× error handling
            try:
                result = json.loads(result_text)
            except json.JSONDecodeError as json_err:
                print(f"âŒ Agent 1 - JSON parse error: {json_err}")
                print(f"   Raw response: {result_text[:100]}...")
                return {
                    'category': 'RELEVANT',
                    'is_broker': False,
                    'confidence': 0.5,
                    'reason': f'JSON parse failed'
                }

            # ×•×œ×™×“×¦×™×”
            if result['confidence'] < 0.5:
                result['category'] = 'RELEVANT'  # ×‘××§×¨×” ×¡×¤×§

            return result

        except Exception as e:
            print(f"âŒ Agent 1 failed: {e}")
            # ×‘×¨×™×¨×ª ××—×“×œ: × × ×™×— ×©×–×” ×¨×œ×•×•× ×˜×™
            return {
                'category': 'RELEVANT',
                'is_broker': False,
                'confidence': 0.5,
                'reason': f'AI failed: {str(e)}'
            }

    # =========================================================
    # Agent 2: Extraction (×—×™×œ×•×¥)
    # =========================================================

    def extract_missing_details(self, content, regex_found, group_name=None):
        """
        Agent 2: ×××œ× ×¤×¨×˜×™× ×—×¡×¨×™× (××—×™×¨, ×¢×™×¨, ××™×§×•×)

        Args:
            content: ×ª×•×›×Ÿ ×”×¤×•×¡×˜
            regex_found: ××” ×©-Regex ×›×‘×¨ ××¦×
                {
                    'price': '7200' | None,
                    'city': '×™×¨×•×©×œ×™×' | None,
                    'location': '×¤×¡×’×ª ×–××‘' | None,
                    'rooms': '4' | None,
                    'phone': '050...' | None
                }
            group_name: ×©× ×§×‘×•×¦×ª ×”×¤×™×™×¡×‘×•×§ (××•×¤×¦×™×•× ×œ×™) - ×œ×¢×–×•×¨ ×‘×–×™×”×•×™ ×¢×™×¨

        Returns:
            {
                'price': '7200' | None,
                'city': '×™×¨×•×©×œ×™×' | None,
                'location': '×¤×¡×’×ª ×–××‘' | None
            }
        """

        self._wait_if_needed()

        # ××” ×—×¡×¨?
        missing = []
        if not regex_found.get('price'):
            missing.append('××—×™×¨')
        if not regex_found.get('city'):
            missing.append('×¢×™×¨')
        if not regex_found.get('location'):  # â† ×”×•×¡×£ ××ª ×–×”!
            missing.append('××™×§×•× (×©×›×•× ×”/×¨×—×•×‘)')

        if not missing:
            # ××™×Ÿ ××” ×œ××œ×!
            return {'price': None, 'city': None, 'location': None}

        missing_str = ', '.join(missing)

        # ×”×›× ×ª ××™×“×¢ ×¢×œ ×§×‘×•×¦×” (×× ×™×©)
        group_info = ""
        if group_name:
            group_info = f"\n    **×§×‘×•×¦×ª ×¤×™×™×¡×‘×•×§:** {group_name}"

        prompt = f"""××ª×” ××•××—×” ×œ×—×™×œ×•×¥ ××™×“×¢ ××¤×•×¡×˜×™× ×‘×¢×‘×¨×™×ª.

    ×§×¨× ××ª ×”×¤×•×¡×˜ ×”×‘× ×•×—×œ×¥ ××ª ×”×¤×¨×˜×™× ×”×—×¡×¨×™×: **{missing_str}**

    **×¤×•×¡×˜:**
    {content[:800]}{group_info}

    ---

    **×”× ×—×™×•×ª ×§×¨×™×˜×™×•×ª:**

1. **××—×™×¨ (××—×™×¨ ×”×“×™×¨×” ×‘×œ×‘×“!)**: 
   - ×—×¤×© ××—×™×¨ ×©×œ ×”×“×™×¨×” ×¢×¦××”
   - **×”×ª×¢×œ× ×××—×™×¨×™× ×©×œ:** ××˜×‘×—, ×©×™×¤×•×¥, ××¨×•× ×•×ª, ×¨×”×™×˜×™×, ×”×©×§×¢×”
   - ×“×•×’×××•×ª ×œ× × ×›×•× ×•×ª: "××˜×‘×— 100,000", "×©×™×¤×•×¥ 50,000"
   - ×× ××™×Ÿ ××—×™×¨ ×“×™×¨×” â†’ null
   
   2. **×¢×™×¨:**
   - ×—×¤×© ×¢×™×¨ ××¤×•×¨×©×ª ××”×¨×©×™××” ×”×¨×œ×•×•× ×˜×™×ª: "×™×¨×•×©×œ×™×", "××¢×œ×” ××“×•××™×", "×‘×™×ª ×©××©", "×‘× ×™ ×‘×¨×§", "×¨××ª ×’×Ÿ", "×’×‘×¢×ª×™×™×", "××©×“×•×“"
   - **×¢×¨×™× ××—×¨×•×ª (×ª×œ ××‘×™×‘, ×—×™×¤×”, ×¤×ª×— ×ª×§×•×•×” ×•×›×•') ×œ× ×¨×œ×•×•× ×˜×™×•×ª!**
   - **×× ×™×© ×©×›×•× ×” ×™×“×•×¢×” â†’ ×”×¡×§ ××ª ×”×¢×™×¨!**
     ×“×•×’××”: "×“×™×¨×” ×‘×§×˜××•×Ÿ" â†’ city: "×™×¨×•×©×œ×™×" (×›×™ ×§×˜××•×Ÿ ×–×• ×©×›×•× ×” ×‘×™×¨×•×©×œ×™×)
     ×“×•×’××”: "×“×™×¨×” ×‘× ×•×•×” ×©××™×¨" â†’ city: "×‘×™×ª ×©××©" (×›×™ × ×•×•×” ×©××™×¨ ×–×• ×©×›×•× ×” ×‘×‘×™×ª ×©××©)
   - **×©×™××•×© ×‘×©× ×§×‘×•×¦×” (×§×“×™××•×ª ×¨××©×•× ×”!):**
     * **×× ×©× ×”×§×‘×•×¦×” ××›×™×œ ×¢×™×¨ ×¨×œ×•×•× ×˜×™×ª** (×™×¨×•×©×œ×™×, ×‘×™×ª ×©××©, ×‘× ×™ ×‘×¨×§ ×•×›×•') **â†’ ×–×• ×”×¢×™×¨!**
     * **×§×¨×™×˜×™:** ×§×‘×•×¦×” "×“×™×¨×•×ª ×‘×™×ª ×©××©" + ×©×›×•× ×” ×‘×¤×•×¡×˜ â†’ city: "×‘×™×ª ×©××©" (×’× ×× ××ª×” ×œ× ××›×™×¨ ××ª ×”×©×›×•× ×”!)
     * ×“×•×’××”: ×§×‘×•×¦×” "×“×™×¨×•×ª ×‘×‘×™×ª ×©××©", ×¤×•×¡×˜ "× ×•×•×” ×©××™×¨" â†’ city: "×‘×™×ª ×©××©" âœ…
     * ×“×•×’××”: ×§×‘×•×¦×” "×“×™×¨×•×ª ×‘×™×¨×•×©×œ×™×", ×¤×•×¡×˜ "×¨×—×•×‘ ×™×¦×—×§ ×‘×Ÿ ×¦×‘×™" â†’ city: "×™×¨×•×©×œ×™×" âœ…
     * **×—×¨×™×’ ×™×—×™×“:** ×× ×”×¤×•×¡×˜ ××–×›×™×¨ ×¢×™×¨ ××—×¨×ª **×‘××¤×•×¨×©** â†’ ×”×©×ª××© ×‘×¢×™×¨ ×”××¤×•×¨×©×ª (×× ×”×™× ×‘×¨×©×™××” ×”×¨×œ×•×•× ×˜×™×ª!)
   - **×× ××™×Ÿ ×¢×™×¨ ××¤×•×¨×©×ª ×•××™×Ÿ ×©×›×•× ×” ×™×“×•×¢×” ×•××™×Ÿ ×¢×™×¨ ××”×§×‘×•×¦×” â†’ null**
   
3. **××™×§×•× (×©×›×•× ×”/×¨×—×•×‘) - ×§×¨×™×˜×™!**
   - **×–×” ×”×©×“×” ×”×›×™ ×—×©×•×‘ - ×ª××™×“ ×—×¤×© ××•×ª×•!**
   - ×—×¤×© ×©×›×•× ×” ×•/××• ×¨×—×•×‘ ×‘×¤×•×¡×˜
   
   **×“×•×’×××•×ª ×œ×©×›×•× ×•×ª:**
   - ×™×¨×•×©×œ×™×: × ×—×œ××•×ª, ×§×˜××•×Ÿ, ×§×¨×™×™×ª ×™×•×‘×œ, ×¤×¡×’×ª ×–××‘, ×’×‘×¢×ª ×©××•×œ, ×ª×œ×¤×™×•×ª, ××¨× ×•× ×”, ×××” ×©×¢×¨×™×, ×’××•×œ×”, ×¨××•×ª, ×¨×•×××”, ×‘×™×ª ×•×’×Ÿ
   - ×‘×™×ª ×©××©: × ×•×•×” ×©××™×¨, ×¨××ª ×‘×™×ª ×©××©, × ×•×¤×™×, ×”×¨ ×˜×•×‘
   - ×‘× ×™ ×‘×¨×§: ×¤×¨×“×¡ ×›×¥, ×¢×–×¨×, ×’×‘×¢×ª ×¨×•×§×—
   - ×¨××ª ×’×Ÿ: ×¨××ª ××¤×¢×œ, ×¨××ª ×™×¦×—×§, ×¨××ª ×—×Ÿ
   
   **×“×•×’×××•×ª ×œ×¨×—×•×‘×•×ª:**
   - "×¨×—×•×‘ ×”×¨×¦×œ", "×¨×—' ×‘×Ÿ ×™×”×•×“×”", "×“×¨×š ×‘×’×™×Ÿ"
   
   **×›×œ×œ×™×:**
   - ×× ×™×© **×¨×§ ×©×›×•× ×”** â†’ ×”×—×–×¨ ×©×›×•× ×”
   - ×× ×™×© **×¨×§ ×¨×—×•×‘** â†’ ×”×—×–×¨ ×¨×—×•×‘
   - ×× ×™×© **×’× ×©×›×•× ×” ×•×’× ×¨×—×•×‘** â†’ ×”×—×–×¨ ××ª ×©× ×™×”× ×‘×¤×•×¨××˜: "×©×›×•× ×”, ×¨×—×•×‘"
   - ×× ×‘×××ª ××™×Ÿ â†’ null
   
   **×“×•×’×××•×ª:**
   - "×“×™×¨×” ×‘×§×¨×™×™×ª ×™×•×‘×œ, ×¨×—×•×‘ ×–'×‘×•×˜×™× ×¡×§×™" â†’ location: "×§×¨×™×™×ª ×™×•×‘×œ, ×¨×—×•×‘ ×–'×‘×•×˜×™× ×¡×§×™"
   - "×“×™×¨×” ×‘×§×¨×™×™×ª ×™×•×‘×œ" â†’ location: "×§×¨×™×™×ª ×™×•×‘×œ"
   - "×“×™×¨×” ×‘×¨×—×•×‘ ×”×¨×¦×œ" â†’ location: "×¨×—×•×‘ ×”×¨×¦×œ"
   - "×“×™×¨×” ×‘×™×¨×•×©×œ×™×" â†’ location: null

   **×–×™×”×•×™ ×©×›×•× ×” ××¨×—×•×‘ ××¨×›×–×™ (×—×©×•×‘!):**
   - ×× ×™×© ×¨×—×•×‘ ××¤×•×¨×© + ×¢×™×¨, **× ×¡×” ×œ×–×”×•×ª ××ª ×”×©×›×•× ×”** ×× ××ª×” ×‘×˜×•×—
   - ×“×•×’×××•×ª:
     * "×¨×—×•×‘ ×¡×•×§×•×œ×•×‘ ×‘×™×¨×•×©×œ×™×" â†’ location: "×’×‘×¢×ª ×©××•×œ, ×¨×—×•×‘ ×¡×•×§×•×œ×•×‘"
     * "×¨×—×•×‘ ×”×¨×‘ ×§×•×§ ×‘×™×¨×•×©×œ×™×" â†’ location: "××¨×›×– ×”×¢×™×¨, ×¨×—×•×‘ ×”×¨×‘ ×§×•×§"
     * "×¨×—×•×‘ ×–'×‘×•×˜×™× ×¡×§×™ ×‘×‘× ×™ ×‘×¨×§" â†’ location: "××¨×›×– ×”×¢×™×¨, ×¨×—×•×‘ ×–'×‘×•×˜×™× ×¡×§×™"
   - **×¨×§ ×× ××ª×” ×‘×˜×•×— 100% ×‘×¨×—×•×‘ ××¨×›×–×™ ×©×™×“×•×¢ ×œ×š ×‘×©×›×•× ×” ××¡×•×™××ª!**
   - ×× ×œ× ×‘×˜×•×— - ×”×—×–×¨ ×¨×§ ××ª ×”×¨×—×•×‘

         **×—×©×•×‘:** ×’× ×× ××™×Ÿ ×¢×™×¨, ×× ×™×© ×¨×—×•×‘ - ×”×—×–×¨ ××•×ª×• ×‘-location!
×“×•×’××”: "×“×™×¨×” ×‘×¨×—×•×‘ ×”××¨×–×™× 12" â†’ city: null, location: "×¨×—×•×‘ ×”××¨×–×™×"         

    4. **×›×œ×œ ×–×”×‘: ×× ×œ× ×‘×˜×•×— â†’ null**

    ---

    **×—×©×•×‘ - ×ª×’×•×‘×•×ª:**
    - ×”×˜×§×¡×˜ ×¢×œ×•×œ ×œ×”×›×™×œ ×ª×’×•×‘×•×ª ×©×œ ×× ×©×™× ××—×¨×™×
    - **×—×œ×¥ ××™×“×¢ ×¨×§ ××”×¤×•×¡×˜ ×”××§×•×¨×™, ×”×ª×¢×œ× ×œ×’××¨×™ ××ª×’×•×‘×•×ª!**
    - ×“×•×’××”: ×× ×‘×¤×•×¡×˜ ×›×ª×•×‘ "7000 ×©×—" ×•×‘×ª×’×•×‘×” "×× ×™ ××•×›×Ÿ 5000" â†’ ×”×—×–×¨ "7000"
    - ×“×•×’××”: ×× ×‘×¤×•×¡×˜ ×›×ª×•×‘ "×‘×™×¨×•×©×œ×™×" ×•×‘×ª×’×•×‘×” "×™×© ×’× ×‘×ª×œ ××‘×™×‘?" â†’ ×”×—×–×¨ "×™×¨×•×©×œ×™×"

    ---

    **×“×•×’×××•×ª ×—×©×•×‘×•×ª:**

    âœ… "×“×™×¨×” ×‘×™×¨×•×©×œ×™× ×‘×¨×—×•×‘ ×”×¨×¦×œ"
       â†’ city: "×™×¨×•×©×œ×™×", location: "×¨×—×•×‘ ×”×¨×¦×œ"

    âœ… "×“×™×¨×” ×‘×¤×¡×’×ª ×–××‘ ×‘×¨×—×•×‘ ××œ×™ ×ª×‘×™×Ÿ"
       â†’ city: "×™×¨×•×©×œ×™×", location: "×¤×¡×’×ª ×–××‘, ×¨×—×•×‘ ××œ×™ ×ª×‘×™×Ÿ" (×©×›×•× ×” ×™×“×•×¢×” â†’ ×”×¡×§ ×¢×™×¨!)

    âœ… "×“×™×¨×” ×‘×§×˜××•× ×™× ×‘×¨×—×•×‘ ×™×•×¡×™ ×‘×Ÿ ×™×•×¢×–×¨"
       â†’ city: "×™×¨×•×©×œ×™×", location: "×§×˜××•×Ÿ, ×¨×—×•×‘ ×™×•×¡×™ ×‘×Ÿ ×™×•×¢×–×¨" (×§×˜××•×Ÿ ×™×“×•×¢ â†’ ×”×¡×§ ×¢×™×¨!)

    âœ… ×§×‘×•×¦×”: "×“×™×¨×•×ª ×‘×™×¨×•×©×œ×™×", ×¤×•×¡×˜: "×“×™×¨×” ×‘×¨×—×•×‘ ×™×¦×—×§ ×‘×Ÿ ×¦×‘×™"
       â†’ city: "×™×¨×•×©×œ×™×", location: "×¨×—×•×‘ ×™×¦×—×§ ×‘×Ÿ ×¦×‘×™" (×”×¡×§ ××”×§×‘×•×¦×”!)

    âŒ "×“×™×¨×” ×‘×¨×—×•×‘ ×”×¨×¦×œ" (×œ×œ× ×§×‘×•×¦×”)
       â†’ city: null, location: "×¨×—×•×‘ ×”×¨×¦×œ" (××™×Ÿ ×©×›×•× ×” ×™×“×•×¢×” - ×¨×§ ×¨×—×•×‘!)

    âŒ "×“×™×¨×” ×‘×¨×—×•×‘ ×‘×’×™×Ÿ ×‘×©×›×•× ×” ×™×¤×”"
       â†’ city: null, location: "×¨×—×•×‘ ×‘×’×™×Ÿ" ("×©×›×•× ×” ×™×¤×”" ×œ× ×©× ×©×›×•× ×” ×××™×ª×™!)
       
               **×“×•×’×××•×ª ××—×™×¨:**
        
        âœ… "×“×™×¨×” ×œ××›×™×¨×” 2,500,000 ×©×´×—" â†’ price: "2500000"
        âœ… "××—×™×¨ ××‘×•×§×©: 3.5 ××™×œ×™×•×Ÿ" â†’ price: "3500000"
        âŒ "××˜×‘×— ×—×“×© 100,000 ×©×´×—" â†’ price: null (×–×” ××—×™×¨ ××˜×‘×—!)
        âŒ "×”×©×§×¢× ×• 200,000 ×‘×©×™×¤×•×¦×™×" â†’ price: null (×–×” ×©×™×¤×•×¥!)
        âŒ "××¨×•× ×•×ª ×‘×”×ª×××” 80,000" â†’ price: null (×–×” ×¨×™×”×•×˜!)
        
        **×× ×™×© ×’× ××—×™×¨ ×“×™×¨×” ×•×’× ××—×™×¨×™× ×©×œ ×©×“×¨×•×’×™× - ×§×— ×¨×§ ××ª ××—×™×¨ ×”×“×™×¨×”!**
        ×“×•×’××”: "×“×™×¨×” 2,800,000 ×©×´×—, ××˜×‘×— 100,000" â†’ price: "2800000"
        
            ---

    **×”×—×–×¨ ×ª×©×•×‘×” ×‘-JSON ×‘×“×™×•×§ ×‘×¤×•×¨××˜ ×”×–×” (×œ×œ× ×˜×§×¡×˜ × ×•×¡×£):**
    {{
        "price": "7200",
        "city": "×™×¨×•×©×œ×™×",
        "location": "×¤×¡×’×ª ×–××‘"
    }}

    ×× ××™×Ÿ ××™×“×¢ â†’ ×”×©×ª××© ×‘-null
    """

        try:
            response = self.client.messages.create(
                model=self.model,
                max_tokens=200,
                temperature=0,
                messages=[{"role": "user", "content": prompt}]
            )

            # ×—×™×œ×•×¥ ×”×ª×©×•×‘×”
            result_text = response.content[0].text.strip()

            # × ×™×§×•×™ markdown backticks
            result_text = result_text.replace('```json', '').replace('```', '').strip()

            # ×”××¨×” ×œ-JSON ×¢× error handling
            try:
                result = json.loads(result_text)
            except json.JSONDecodeError as json_err:
                print(f"âŒ Agent 2 - JSON parse error: {json_err}")
                print(f"   Raw response: {result_text[:100]}...")
                return {'price': None, 'city': None, 'location': None}

            # ×•×œ×™×“×¦×™×”: ×¨×§ ××—×–×™×¨×™× ××” ×©×”×™×” ×—×¡×¨
            output = {}

            if not regex_found.get('price'):
                output['price'] = result.get('price')

            if not regex_found.get('city'):
                output['city'] = result.get('city')

            if not regex_found.get('location'):
                output['location'] = result.get('location')

            return output

        except Exception as e:
            print(f"âŒ Agent 2 failed: {e}")
            return {'price': None, 'city': None, 'location': None}