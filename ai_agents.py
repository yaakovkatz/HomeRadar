"""
ai_agents.py - AI Agents for post classification and data extraction
Agent 1: Classification (RELEVANT/SPAM/BROKER/etc) - with image support
Agent 2: Extraction (fill missing price/city)
"""

import os
import json
from anthropic import Anthropic
from dotenv import load_dotenv
import time


# ×˜×¢×™× ×ª API Key ×-.env
load_dotenv()


class AIAgents:
    def __init__(self):
        """Initialize AI Agents with Anthropic API"""
        api_key = os.getenv('ANTHROPIC_API_KEY')
        if not api_key:
            raise ValueError("âŒ ANTHROPIC_API_KEY ×œ× × ××¦× ×‘×§×•×‘×¥ .env")

        self.client = Anthropic(api_key=api_key)
        self.model = "claude-sonnet-4-20250514"  # Sonnet 4

        self.last_call = 0
        self.min_delay = 0.5  # 500ms ×‘×™×Ÿ ×§×¨×™××•×ª

        print("âœ… AI Agents initialized successfully")

    def _wait_if_needed(self):
        """×××ª×™×Ÿ ×× ×¢×‘×¨×• ×¤×—×•×ª ×-500ms ××”×§×¨×™××” ×”××—×¨×•× ×”"""
        now = time.time()
        elapsed = now - self.last_call
        if elapsed < self.min_delay:
            time.sleep(self.min_delay - elapsed)
        self.last_call = time.time()

    # =========================================================
    # Agent 1: Classification (×¡×™× ×•×Ÿ) - ×¢× ×ª××™×›×” ×‘×ª××•× ×•×ª
    # =========================================================

    def classify_post(self, content, author, images=None):
        """
        Agent 1: ××¡×•×•×’ ×¤×•×¡×˜ ×œ×§×˜×’×•×¨×™×” (×¢× ×ª××™×›×” ×‘×ª××•× ×•×ª!)

        Args:
            content: ×ª×•×›×Ÿ ×”×¤×•×¡×˜
            author: ×©× ×”××¤×¨×¡×
            images: ×¨×©×™××ª URLs ×©×œ ×ª××•× ×•×ª (××•×¤×¦×™×•× ×œ×™)

        Returns:
            {
                'category': 'RELEVANT' | 'BROKER' | 'SPAM' | 'AUCTION' | 'WANTED' | 'QUESTION',
                'is_broker': True/False,
                'confidence': 0.0-1.0,
                'reason': '×”×¡×‘×¨ ×§×¦×¨'
            }
        """

        self._wait_if_needed()

        prompt = f"""××ª×” ××•××—×” ×œ×¡×™×•×•×’ ×¤×•×¡×˜×™× ×‘×§×‘×•×¦×•×ª ×¤×™×™×¡×‘×•×§ ×©×œ ×“×™×¨×•×ª ×™×“ ×©× ×™×™×”.

{"×§×¨× ××ª ×”×ª××•× ×•×ª ×•×”×¤×•×¡×˜" if images else "×§×¨× ××ª ×”×¤×•×¡×˜ ×”×‘×"} ×•×¡×•×•×’ ××•×ª×• ×œ××—×ª ××”×§×˜×’×•×¨×™×•×ª:

**RELEVANT** - ×“×™×¨×” ×œ××›×™×¨×”/×”×©×›×¨×” (×¨×œ×•×•× ×˜×™!)
- ×™×© ×ª×™××•×¨ ×“×™×¨×” (×—×“×¨×™×, ××˜×¨, ×§×•××” ×•×›×•')
- ×™×›×•×œ ×œ×”×™×•×ª ×¢× ××• ×‘×œ×™ ××—×™×¨
- ×™×›×•×œ ×œ×”×™×•×ª ×××ª×•×•×š ××• ××‘×¢×œ×™×

**AUCTION** - ××›×¨×–/×›×•× ×¡ × ×›×¡×™×/××›×™×¨×” ×¤×•××‘×™×ª
- ×ª××•× ×” ××• ×˜×§×¡×˜ ×¢× "×›×•× ×¡ × ×›×¡×™×", "××›×¨×–", "×”×–×× ×” ×œ×”×¦×™×¢ ×”×¦×¢×•×ª"
- ××›×™×¨×” ×¤×•××‘×™×ª, ×¨×›×™×©×ª ×–×›×•×™×•×ª

**BROKER** - ××ª×•×•×š ××—×¤×© ×œ×§×•×—×•×ª (×œ× ×“×™×¨×” ×¡×¤×¦×™×¤×™×ª!)
- ×›×ª×•×‘ "××—×¤×© ×œ×§×•×—×•×ª", "×ª×™×§ × ×›×¡×™×", "×©×™×¨×•×ª ×ª×™×•×•×š"
- ××™×Ÿ ×ª×™××•×¨ ×“×™×¨×” ×¡×¤×¦×™×¤×™×ª

**×–×™×”×•×™ ××ª×•×•×›×™× ×¡××•×™×™× (×—×©×•×‘!):**
××ª×•×•×›×™× ×œ×¤×¢××™× **××¡×ª×™×¨×™×** ×©×”× ××ª×•×•×›×™×. ×©×™× ×œ×‘ ×œ:
- âœ… ×—×ª×™××” ×¢×¡×§×™×ª: "× ×“×œ×´×Ÿ JF", "Real Estate X", "× ×›×¡×™× ×¤×œ×•×¡", "××§×¡×™× × ×“×œ×´×Ÿ"
- âœ… ××¡×¤×¨ × ×›×¡×™× ×‘××•×ª×• ×¤×•×¡×˜ (×™×•×ª×¨ ××“×™×¨×” ××—×ª)
- âœ… ×˜×•×Ÿ ×¢×¡×§×™ + ×—×ª×™××” ××§×¦×•×¢×™×ª: "×œ×¤×¨×˜×™× ×•×ª×™××•×: ×©×™×¨×” 050-1234567"
- âœ… ×¨×™×‘×•×™ ××™×™×§×•× ×™× ×¤×¨×¡×•××™×™× (âœ¨ğŸ“ğŸ’ğŸ ) + ×¢×™×¦×•×‘ ××¡×—×¨×™
- âœ… ×›×•×ª×¨×ª ××¡×—×¨×™×ª: "×¢×¡×§×ª ×¤×¨×™××™×•×!", "×”×–×“×× ×•×ª × ×“×™×¨×”!", "×‘×œ×¢×“×™!"

**××‘×œ ×©×™× ×œ×‘:**
- âŒ ××“× ×¤×¨×˜×™ ×©×›×•×ª×‘ ×˜×•×‘ â‰  ××ª×•×•×š
- âŒ ×©×™××•×© ×‘×××•×’'×™× ×‘×œ×‘×“ â‰  ××ª×•×•×š
- âŒ ×¤×•×¡×˜ ××¡×•×“×¨ ×¢× ×¤×¨×˜×™× â‰  ××ª×•×•×š

**×× ×–×” ××ª×•×•×š ×¡××•×™:**
â†’ category: "RELEVANT", is_broker: true, reason: "××ª×•×•×š (×—×ª×™××” ×¢×¡×§×™×ª: × ×“×œ×´×Ÿ X)"

**SPAM** - ×¤×¨×¡×•× ×œ× ×§×©×•×¨
- ×©×™×¤×•×¦×™×, × ×§×™×•×Ÿ, ×”×•×‘×œ×•×ª (×‘×ª××•× ×” ××• ×‘×˜×§×¡×˜)
- ×œ× ×§×©×•×¨ ×œ×“×™×¨×•×ª

**WANTED** - ××—×¤×© ×“×™×¨×” (×œ× ××•×›×¨!)
- "××—×¤×© ×“×™×¨×”", "×“×¨×•×©", "×¦×¨×™×š"

**QUESTION** - ×©××œ×”
- "××™×©×”×• ×™×•×“×¢?", "××™×š...?", "×¢×–×¨×”"

---

**×¤×•×¡×˜:**
××¤×¨×¡×: {author}
×ª×•×›×Ÿ: {content[:500]}
{"×ª××•× ×•×ª: ××¦×•×¨×¤×•×ª (×§×¨× ××•×ª×Ÿ!)" if images else ""}

---

**×—×©×•×‘ - ×ª××•× ×•×ª:**
- ×× ×™×© ×ª××•× ×” ×¢× "×›×•× ×¡ × ×›×¡×™×", "××›×¨×–", "×”×–×× ×” ×œ×”×¦×™×¢ ×”×¦×¢×•×ª" â†’ AUCTION
- ×× ×™×© ×ª××•× ×” ×©×œ ×¤×¨×¡×•× (×”×•×‘×œ×•×ª, ×©×™×¤×•×¦×™×, × ×§×™×•×Ÿ) â†’ SPAM
- ×§×¨× ××ª ×”×ª××•× ×•×ª ×‘×§×¤×™×“×”!

**×—×©×•×‘ - ×ª×’×•×‘×•×ª:**
- ×”×˜×§×¡×˜ ×¢×œ×•×œ ×œ×”×›×™×œ ×ª×’×•×‘×•×ª ×©×œ ×× ×©×™× ××—×¨×™× (×›××• "××©×”: ×ª×’×•×‘×ª×™ ×××•×“!")
- **×”×ª×¢×œ× ×œ×’××¨×™ ××ª×’×•×‘×•×ª!**
- ×”×ª××§×“ **×¨×§ ×‘×ª×•×›×Ÿ ×”××§×•×¨×™** ×©×œ ×”×¤×•×¡×˜
- ×ª×’×•×‘×•×ª ××ª×—×™×œ×•×ª ×œ×¨×•×‘ ×‘×©× ××“× + "×ª×’×•×‘×ª×™", "××” ×–×”", "×™×§×¨ ××“×™" ×•×›×•'
- ×× ×™×© ×ª×™××•×¨ ×“×™×¨×” ×‘×¤×•×¡×˜ ×”××§×•×¨×™ â†’ RELEVANT (×’× ×× ×™×© ×ª×’×•×‘×” ×©××œ×”!)

---

**×”×—×–×¨ ×ª×©×•×‘×” ×‘-JSON ×‘×“×™×•×§ ×‘×¤×•×¨××˜ ×”×–×” (×œ×œ× ×˜×§×¡×˜ × ×•×¡×£):**
{{
    "category": "RELEVANT",
    "is_broker": false,
    "confidence": 0.95,
    "reason": "×“×™×¨×” ×œ××›×™×¨×” ×¢× ×ª×™××•×¨ ××¤×•×¨×˜"
}}

**×›×œ×œ×™×:**
1. ×× ×–×• ×“×™×¨×” ×××ª×•×•×š (×’×œ×•×™ ××• ×¡××•×™) â†’ category: "RELEVANT", is_broker: true
2. ×× ××ª×•×•×š ××—×¤×© ×œ×§×•×—×•×ª â†’ category: "BROKER", is_broker: true
3. ×× ××›×¨×–/×›×•× ×¡ × ×›×¡×™× â†’ category: "AUCTION", is_broker: false
4. confidence: 0.5-1.0 (×¢×“ ×›××” ××ª×” ×‘×˜×•×—)
5. ×× confidence < 0.5 â†’ category: "RELEVANT" (×‘××§×¨×” ×¡×¤×§)
6. **××ª×•×•×š ×¡××•×™** (×—×ª×™××” "× ×“×œ×´×Ÿ X", ××¡×¤×¨ × ×›×¡×™×, ×•×›×•') â†’ is_broker: true

**×“×•×’×××•×ª:**

âœ… ××ª×•×•×š ×¡××•×™:
"×“×™×¨×ª 4 ×—×“×¨×™× ××“×”×™××” âœ¨ ×‘××™×§×•× ×¤×¨×™××™×•× ğŸ“
×œ×¤×¨×˜×™× ×•×ª×™××•×: ×¡×ª×™×• - × ×“×œ×´×Ÿ JF ğŸ“ 054-7895735"
â†’ category: "RELEVANT", is_broker: true, reason: "××ª×•×•×š ×¡××•×™ (×—×ª×™××”: × ×“×œ×´×Ÿ JF)"

âœ… ××ª×•×•×š ×¡××•×™:
"ğŸ’ 3 ×“×™×¨×•×ª ×—×“×©×•×ª ×‘×ª×œ ××‘×™×‘! ğŸ 
Real Estate Plus | ×©×™×¨×” 050-1234567"
â†’ category: "RELEVANT", is_broker: true, reason: "××ª×•×•×š ×¡××•×™ (××¡×¤×¨ × ×›×¡×™× + Real Estate Plus)"

âŒ ×œ× ××ª×•×•×š:
"×“×™×¨×” ×™×¤×” ×œ×”×©×›×¨×”! 3 ×—×“×¨×™×, ××¢×œ×™×ª, ×—× ×™×” ğŸ¡
×œ××¢×•× ×™×™× ×™×: ×™×•×¡×™ 052-9876543"
â†’ category: "RELEVANT", is_broker: false, reason: "××“× ×¤×¨×˜×™ (××™×Ÿ ×¡×™×× ×™ ×ª×™×•×•×š)"
"""

        try:
            # ×‘× ×™×™×ª message ×¢× ×ª××•× ×•×ª
            message_content = []

            # ×× ×™×© ×ª××•× ×•×ª - ×”×•×¡×£ ××•×ª×Ÿ ×§×•×“×
            if images:
                for image_url in images:
                    message_content.append({
                        "type": "image",
                        "source": {
                            "type": "url",
                            "url": image_url
                        }
                    })

            # ×”×•×¡×£ ××ª ×”×˜×§×¡×˜
            message_content.append({
                "type": "text",
                "text": prompt
            })

            # ×©×œ×— ×œ-Claude
            response = self.client.messages.create(
                model=self.model,
                max_tokens=200,
                temperature=0,
                messages=[{"role": "user", "content": message_content}]
            )

            # ×—×™×œ×•×¥ ×”×ª×©×•×‘×”
            result_text = response.content[0].text.strip()

            # × ×™×§×•×™ markdown backticks ×× ×™×©
            result_text = result_text.replace('```json', '').replace('```', '').strip()

            # ×”××¨×” ×œ-JSON
            result = json.loads(result_text)

            # ×•×œ×™×“×¦×™×”
            if result['confidence'] < 0.5:
                result['category'] = 'RELEVANT'  # ×‘××§×¨×” ×¡×¤×§

            return result

        except Exception as e:
            print(f"âŒ Agent 1 failed: {e}")
            # ×‘×¨×™×¨×ª ××—×“×œ: × × ×™×— ×©×–×” ×¨×œ×•×•× ×˜×™
            return {
                'category': 'RELEVANT',
                'is_broker': False,
                'confidence': 0.5,
                'reason': f'AI failed: {str(e)}'
            }

    # =========================================================
    # Agent 2: Extraction (×—×™×œ×•×¥)
    # =========================================================

    def extract_missing_details(self, content, regex_found):
        """
        Agent 2: ×××œ× ×¤×¨×˜×™× ×—×¡×¨×™× (××—×™×¨, ×¢×™×¨, ××™×§×•×)

        Args:
            content: ×ª×•×›×Ÿ ×”×¤×•×¡×˜
            regex_found: ××” ×©-Regex ×›×‘×¨ ××¦×
                {
                    'price': '7200' | None,
                    'city': '×™×¨×•×©×œ×™×' | None,
                    'location': '×¤×¡×’×ª ×–××‘' | None,
                    'rooms': '4' | None,
                    'phone': '050...' | None
                }

        Returns:
            {
                'price': '7200' | None,
                'city': '×™×¨×•×©×œ×™×' | None,
                'location': '×¤×¡×’×ª ×–××‘' | None
            }
        """

        self._wait_if_needed()

        # ××” ×—×¡×¨?
        missing = []
        if not regex_found.get('price'):
            missing.append('××—×™×¨')
        if not regex_found.get('city'):
            missing.append('×¢×™×¨')
        if not regex_found.get('location'):  # â† ×”×•×¡×£ ××ª ×–×”!
            missing.append('××™×§×•× (×©×›×•× ×”/×¨×—×•×‘)')

        if not missing:
            # ××™×Ÿ ××” ×œ××œ×!
            return {'price': None, 'city': None, 'location': None}

        missing_str = ', '.join(missing)

        prompt = f"""××ª×” ××•××—×” ×œ×—×™×œ×•×¥ ××™×“×¢ ××¤×•×¡×˜×™× ×‘×¢×‘×¨×™×ª.

    ×§×¨× ××ª ×”×¤×•×¡×˜ ×”×‘× ×•×—×œ×¥ ××ª ×”×¤×¨×˜×™× ×”×—×¡×¨×™×: **{missing_str}**

    **×¤×•×¡×˜:**
    {content[:800]}

    ---

    **×”× ×—×™×•×ª ×§×¨×™×˜×™×•×ª:**

1. **××—×™×¨ (××—×™×¨ ×”×“×™×¨×” ×‘×œ×‘×“!)**: 
   - ×—×¤×© ××—×™×¨ ×©×œ ×”×“×™×¨×” ×¢×¦××”
   - **×”×ª×¢×œ× ×××—×™×¨×™× ×©×œ:** ××˜×‘×—, ×©×™×¤×•×¥, ××¨×•× ×•×ª, ×¨×”×™×˜×™×, ×”×©×§×¢×”
   - ×“×•×’×××•×ª ×œ× × ×›×•× ×•×ª: "××˜×‘×— 100,000", "×©×™×¤×•×¥ 50,000"
   - ×× ××™×Ÿ ××—×™×¨ ×“×™×¨×” â†’ null
   
   2. **×¢×™×¨:**
   - ×—×¤×© ×¢×™×¨ ××¤×•×¨×©×ª: "×‘×™×¨×•×©×œ×™×", "×ª×œ ××‘×™×‘", "×—×™×¤×”"
   - **×× ×™×© ×©×›×•× ×” ×™×“×•×¢×” â†’ ×”×¡×§ ××ª ×”×¢×™×¨!**
     ×“×•×’××”: "×“×™×¨×” ×‘×§×˜××•×Ÿ" â†’ city: "×™×¨×•×©×œ×™×" (×›×™ ×§×˜××•×Ÿ ×–×• ×©×›×•× ×” ×‘×™×¨×•×©×œ×™×)
     ×“×•×’××”: "×“×™×¨×” ×‘×¤×œ×•×¨× ×˜×™×Ÿ" â†’ city: "×ª×œ ××‘×™×‘" (×›×™ ×¤×œ×•×¨× ×˜×™×Ÿ ×–×• ×©×›×•× ×” ×‘×ª×œ ××‘×™×‘)
   - **×× ××™×Ÿ ×¢×™×¨ ××¤×•×¨×©×ª ×•××™×Ÿ ×©×›×•× ×” ×™×“×•×¢×” â†’ null**
   
3. **××™×§×•× (×©×›×•× ×”/×¨×—×•×‘) - ×§×¨×™×˜×™!**
   - **×–×” ×”×©×“×” ×”×›×™ ×—×©×•×‘ - ×ª××™×“ ×—×¤×© ××•×ª×•!**
   - ×—×¤×© ×©×›×•× ×” ×•/××• ×¨×—×•×‘ ×‘×¤×•×¡×˜
   
   **×“×•×’×××•×ª ×œ×©×›×•× ×•×ª:**
   - ×™×¨×•×©×œ×™×: ×§×˜××•×Ÿ, ×§×¨×™×™×ª ×™×•×‘×œ, ×¤×¡×’×ª ×–××‘, ×’×‘×¢×ª ×©××•×œ, ×ª×œ×¤×™×•×ª, ××¨× ×•× ×”
   - ×ª×œ ××‘×™×‘: ×“×™×–× ×’×•×£, ×¤×œ×•×¨× ×˜×™×Ÿ, × ×•×•×” ×¦×“×§, ×¨××ª ××‘×™×‘
   
   **×“×•×’×××•×ª ×œ×¨×—×•×‘×•×ª:**
   - "×¨×—×•×‘ ×”×¨×¦×œ", "×¨×—' ×‘×Ÿ ×™×”×•×“×”", "×“×¨×š ×‘×’×™×Ÿ"
   
   **×›×œ×œ×™×:**
   - ×× ×™×© **×¨×§ ×©×›×•× ×”** â†’ ×”×—×–×¨ ×©×›×•× ×”
   - ×× ×™×© **×¨×§ ×¨×—×•×‘** â†’ ×”×—×–×¨ ×¨×—×•×‘
   - ×× ×™×© **×’× ×©×›×•× ×” ×•×’× ×¨×—×•×‘** â†’ ×”×—×–×¨ ××ª ×©× ×™×”× ×‘×¤×•×¨××˜: "×©×›×•× ×”, ×¨×—×•×‘"
   - ×× ×‘×××ª ××™×Ÿ â†’ null
   
   **×“×•×’×××•×ª:**
   - "×“×™×¨×” ×‘×§×¨×™×™×ª ×™×•×‘×œ, ×¨×—×•×‘ ×–'×‘×•×˜×™× ×¡×§×™" â†’ location: "×§×¨×™×™×ª ×™×•×‘×œ, ×¨×—×•×‘ ×–'×‘×•×˜×™× ×¡×§×™"
   - "×“×™×¨×” ×‘×§×¨×™×™×ª ×™×•×‘×œ" â†’ location: "×§×¨×™×™×ª ×™×•×‘×œ"
   - "×“×™×¨×” ×‘×¨×—×•×‘ ×”×¨×¦×œ" â†’ location: "×¨×—×•×‘ ×”×¨×¦×œ"
   - "×“×™×¨×” ×‘×™×¨×•×©×œ×™×" â†’ location: null
   
         **×—×©×•×‘:** ×’× ×× ××™×Ÿ ×¢×™×¨, ×× ×™×© ×¨×—×•×‘ - ×”×—×–×¨ ××•×ª×• ×‘-location!
×“×•×’××”: "×“×™×¨×” ×‘×¨×—×•×‘ ×”××¨×–×™× 12" â†’ city: null, location: "×¨×—×•×‘ ×”××¨×–×™×"         

    4. **×›×œ×œ ×–×”×‘: ×× ×œ× ×‘×˜×•×— â†’ null**

    ---

    **×—×©×•×‘ - ×ª×’×•×‘×•×ª:**
    - ×”×˜×§×¡×˜ ×¢×œ×•×œ ×œ×”×›×™×œ ×ª×’×•×‘×•×ª ×©×œ ×× ×©×™× ××—×¨×™×
    - **×—×œ×¥ ××™×“×¢ ×¨×§ ××”×¤×•×¡×˜ ×”××§×•×¨×™, ×”×ª×¢×œ× ×œ×’××¨×™ ××ª×’×•×‘×•×ª!**
    - ×“×•×’××”: ×× ×‘×¤×•×¡×˜ ×›×ª×•×‘ "7000 ×©×—" ×•×‘×ª×’×•×‘×” "×× ×™ ××•×›×Ÿ 5000" â†’ ×”×—×–×¨ "7000"
    - ×“×•×’××”: ×× ×‘×¤×•×¡×˜ ×›×ª×•×‘ "×‘×™×¨×•×©×œ×™×" ×•×‘×ª×’×•×‘×” "×™×© ×’× ×‘×ª×œ ××‘×™×‘?" â†’ ×”×—×–×¨ "×™×¨×•×©×œ×™×"

    ---

    **×“×•×’×××•×ª ×—×©×•×‘×•×ª:**

    âœ… "×“×™×¨×” ×‘×™×¨×•×©×œ×™× ×‘×¨×—×•×‘ ×”×¨×¦×œ" 
       â†’ city: "×™×¨×•×©×œ×™×", location: "×¨×—×•×‘ ×”×¨×¦×œ"

    âœ… "×“×™×¨×” ×‘×¤×¡×’×ª ×–××‘ ×‘×¨×—×•×‘ ××œ×™ ×ª×‘×™×Ÿ"
       â†’ city: "×™×¨×•×©×œ×™×", location: "×¤×¡×’×ª ×–××‘, ×¨×—×•×‘ ××œ×™ ×ª×‘×™×Ÿ" (×©×›×•× ×” ×™×“×•×¢×” â†’ ×”×¡×§ ×¢×™×¨!)

    âœ… "×“×™×¨×” ×‘×§×˜××•× ×™× ×‘×¨×—×•×‘ ×™×•×¡×™ ×‘×Ÿ ×™×•×¢×–×¨"
       â†’ city: "×™×¨×•×©×œ×™×", location: "×§×˜××•×Ÿ, ×¨×—×•×‘ ×™×•×¡×™ ×‘×Ÿ ×™×•×¢×–×¨" (×§×˜××•×Ÿ ×™×“×•×¢ â†’ ×”×¡×§ ×¢×™×¨!)

    âŒ "×“×™×¨×” ×‘×¨×—×•×‘ ×”×¨×¦×œ"
       â†’ city: null, location: "×¨×—×•×‘ ×”×¨×¦×œ" (××™×Ÿ ×©×›×•× ×” ×™×“×•×¢×” - ×¨×§ ×¨×—×•×‘!)

    âŒ "×“×™×¨×” ×‘×¨×—×•×‘ ×‘×’×™×Ÿ ×‘×©×›×•× ×” ×™×¤×”"
       â†’ city: null, location: "×¨×—×•×‘ ×‘×’×™×Ÿ" ("×©×›×•× ×” ×™×¤×”" ×œ× ×©× ×©×›×•× ×” ×××™×ª×™!)
       
               **×“×•×’×××•×ª ××—×™×¨:**
        
        âœ… "×“×™×¨×” ×œ××›×™×¨×” 2,500,000 ×©×´×—" â†’ price: "2500000"
        âœ… "××—×™×¨ ××‘×•×§×©: 3.5 ××™×œ×™×•×Ÿ" â†’ price: "3500000"
        âŒ "××˜×‘×— ×—×“×© 100,000 ×©×´×—" â†’ price: null (×–×” ××—×™×¨ ××˜×‘×—!)
        âŒ "×”×©×§×¢× ×• 200,000 ×‘×©×™×¤×•×¦×™×" â†’ price: null (×–×” ×©×™×¤×•×¥!)
        âŒ "××¨×•× ×•×ª ×‘×”×ª×××” 80,000" â†’ price: null (×–×” ×¨×™×”×•×˜!)
        
        **×× ×™×© ×’× ××—×™×¨ ×“×™×¨×” ×•×’× ××—×™×¨×™× ×©×œ ×©×“×¨×•×’×™× - ×§×— ×¨×§ ××ª ××—×™×¨ ×”×“×™×¨×”!**
        ×“×•×’××”: "×“×™×¨×” 2,800,000 ×©×´×—, ××˜×‘×— 100,000" â†’ price: "2800000"
        
            ---

    **×”×—×–×¨ ×ª×©×•×‘×” ×‘-JSON ×‘×“×™×•×§ ×‘×¤×•×¨××˜ ×”×–×” (×œ×œ× ×˜×§×¡×˜ × ×•×¡×£):**
    {{
        "price": "7200",
        "city": "×™×¨×•×©×œ×™×",
        "location": "×¤×¡×’×ª ×–××‘"
    }}

    ×× ××™×Ÿ ××™×“×¢ â†’ ×”×©×ª××© ×‘-null
    """

        try:
            response = self.client.messages.create(
                model=self.model,
                max_tokens=200,
                temperature=0,
                messages=[{"role": "user", "content": prompt}]
            )

            # ×—×™×œ×•×¥ ×”×ª×©×•×‘×”
            result_text = response.content[0].text.strip()

            # × ×™×§×•×™ markdown backticks
            result_text = result_text.replace('```json', '').replace('```', '').strip()

            # ×”××¨×” ×œ-JSON
            result = json.loads(result_text)

            # ×•×œ×™×“×¦×™×”: ×¨×§ ××—×–×™×¨×™× ××” ×©×”×™×” ×—×¡×¨
            output = {}

            if not regex_found.get('price'):
                output['price'] = result.get('price')

            if not regex_found.get('city'):
                output['city'] = result.get('city')

            if not regex_found.get('location'):
                output['location'] = result.get('location')

            return output

        except Exception as e:
            print(f"âŒ Agent 2 failed: {e}")
            return {'price': None, 'city': None, 'location': None}